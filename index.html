<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Map Compare - visually compare two map styles</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://unpkg.com/maplibre-gl@5.10.0/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@5.10.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@maplibre/maplibre-gl-compare@0.5.0/dist/maplibre-gl-compare.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@maplibre/maplibre-gl-compare@0.5.0/dist/maplibre-gl-compare.css"
      type="text/css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto,
          'Helvetica Neue', Arial;
      }
      body * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      .config-btn {
        position: absolute;
        z-index: 1000;
        top: 12px;
        right: 12px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .config-panel {
        position: absolute;
        z-index: 1000;
        top: 56px;
        right: 12px;
        width: 420px;
        max-width: calc(100% - 32px);
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 12px;
        display: none;
      }
      .config-panel h3 {
        margin: 6px 0 8px 0;
        font-size: 14px;
      }
      .config-row {
        margin-bottom: 10px;
      }
      .config-row label {
        display: block;
        font-size: 12px;
        margin-bottom: 6px;
      }
      .style-input {
        width: 100%;
        min-height: 88px;
        box-sizing: border-box;
        padding: 8px;
        font-family: monospace;
        font-size: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
      }
      .config-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }
      .btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        cursor: pointer;
      }
      .btn.primary {
        background: #2b7cff;
        color: white;
        border: none;
      }
      .btn.ghost {
        background: transparent;
      }
      .status {
        font-size: 12px;
        color: #b00;
        min-height: 18px;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div id="comparison-container">
      <div id="left" class="map"></div>
      <div id="right" class="map"></div>
    </div>
    <button id="open-config" class="config-btn" title="Open configuration">
      ⚙️ Config
    </button>

    <div
      id="config-panel"
      class="config-panel"
      role="dialog"
      aria-label="Map style configuration"
    >
      <h3>Map Styles</h3>
      <div class="config-row">
        <label for="left-style">Left map style (URL or paste full JSON)</label>
        <textarea
          id="left-style"
          class="style-input"
          placeholder="https://example.com/style.json or paste JSON here"
        ></textarea>
      </div>
      <div class="config-row">
        <label for="right-style"
          >Right map style (URL or paste full JSON)</label
        >
        <textarea
          id="right-style"
          class="style-input"
          placeholder="https://example.com/style.json or paste JSON here"
        ></textarea>
      </div>
      <div class="status" id="config-status" aria-live="polite"></div>
      <div class="config-actions">
        <button id="reset-config" class="btn ghost">Reset</button>
        <button id="apply-config" class="btn primary">Apply</button>
      </div>
    </div>
    <script>
      const LS_LEFT = 'map-compare:left-style'
      const LS_RIGHT = 'map-compare:right-style'
      const DEFAULT_LEFT_STYLE = 'https://demotiles.maplibre.org/style.json'
      const DEFAULT_RIGHT_STYLE =
        'https://api.protomaps.com/styles/v5/light/en.json?key=498e4a2080b69126'
      const initLeftStyle =
        localStorage.getItem(LS_LEFT) ||
        'https://demotiles.maplibre.org/style.json'
      const initRightStyle =
        localStorage.getItem(LS_RIGHT) ||
        'https://api.protomaps.com/styles/v5/light/en.json?key=498e4a2080b69126'

      const leftMap = new maplibregl.Map({
        container: 'left',
        style: parseStyleInput(initLeftStyle).value,
        hash: true,
      })

      const rightMap = new maplibregl.Map({
        container: 'right',
        style: parseStyleInput(initRightStyle).value,
        hash: true,
      })

      const map = new maplibregl.Compare(
        leftMap,
        rightMap,
        '#comparison-container'
      )

      const openBtn = document.getElementById('open-config')
      const panel = document.getElementById('config-panel')
      const leftInput = document.getElementById('left-style')
      const rightInput = document.getElementById('right-style')
      const applyBtn = document.getElementById('apply-config')
      const resetBtn = document.getElementById('reset-config')
      const statusEl = document.getElementById('config-status')

      leftInput.value = initLeftStyle
      rightInput.value = initRightStyle

      function showStatus(msg, isError = true) {
        statusEl.style.color = isError ? '#b00' : '#0b6'
        statusEl.textContent = msg
      }

      function clearStatus() {
        statusEl.textContent = ''
      }

      openBtn.addEventListener('click', () => {
        panel.style.display =
          panel.style.display === 'none' || panel.style.display === ''
            ? 'block'
            : 'none'
      })

      function parseStyleInput(text) {
        const t = (text || '').trim()
        if (!t) return { type: 'empty' }
        // JSON likely starts with { or [
        if (t[0] === '{' || t[0] === '[') {
          try {
            const obj = JSON.parse(t)
            return { type: 'json', value: obj }
          } catch (err) {
            return { type: 'invalid-json', error: err }
          }
        }

        if (/\{[zZ]\}|\{[xX]\}|\{[yY]\}/.test(t)) {
          return { type: 'tile-template', value: t }
        }

        // Otherwise treat as URL (likely a style.json URL)
        return { type: 'url', value: t }
      }

      async function applyStyleToMap(mapInstance, inputText) {
        const parsed = parseStyleInput(inputText)
        if (parsed.type === 'empty') throw new Error('Empty style input')
        if (parsed.type === 'invalid-json') throw parsed.error
        if (parsed.type === 'json') {
          mapInstance.setStyle(parsed.value)
        } else if (parsed.type === 'tile-template') {
          mapInstance.setStyle({
            version: 8,
            name: parsed.value,
            sources: {
              'simple-tiles': {
                type: 'raster',
                tiles: [parsed.value],
                tileSize: 256,
              },
            },
            layers: [
              {
                id: 'simple-tiles-layer',
                type: 'raster',
                source: 'simple-tiles',
              },
            ],
          })
        } else {
          mapInstance.setStyle(parsed.value)
        }
      }

      applyBtn.addEventListener('click', async () => {
        clearStatus()
        applyBtn.disabled = true
        try {
          await Promise.all([
            applyStyleToMap(leftMap, leftInput.value),
            applyStyleToMap(rightMap, rightInput.value),
          ])
          showStatus('Styles applied', false)
          localStorage.setItem(LS_LEFT, leftInput.value)
          localStorage.setItem(LS_RIGHT, rightInput.value)
        } catch (err) {
          console.error(err)
          showStatus(
            'Failed to apply style: ' +
              (err && err.message ? err.message : String(err))
          )
        } finally {
          applyBtn.disabled = false
        }
      })

      resetBtn.addEventListener('click', async () => {
        localStorage.removeItem(LS_LEFT)
        localStorage.removeItem(LS_RIGHT)
        leftInput.value = DEFAULT_LEFT_STYLE
        rightInput.value = DEFAULT_RIGHT_STYLE
        clearStatus()
        applyBtn.click()
      })

      document.addEventListener('click', (ev) => {
        if (!panel.contains(ev.target) && ev.target !== openBtn) {
          panel.style.display = 'none'
        }
      })

      document.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') panel.style.display = 'none'
      })
    </script>
  </body>
</html>
